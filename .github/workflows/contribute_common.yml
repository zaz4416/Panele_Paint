name: Contribute zazlib to Common Lib

on:
  push:
    # --- 発火条件の定義 ---
    paths:
      - 'zazlib/**' # zazlib内の変更時のみ発火（他のファイル修正では動かさない）
    branches:
      - main       # メインブランチへの Push を監視

jobs:
  contribute:
    runs-on: ubuntu-latest
    steps:
      # --- 1. このプロジェクト自身をチェックアウト ---
      - name: Checkout Project
        uses: actions/checkout@v4
        with:
          path: project-repo
          token: ${{ secrets.MY_PAT }} # 最強の合鍵(MY_PAT)を使用して自身のコードを取得

      # --- 2. 届け先である「共通リポジトリ(ZazLib)」をチェックアウト ---
      - name: Checkout Common Lib
        uses: actions/checkout@v4
        with:
          repository: zaz4416/ZazLib # 共通リポジトリを指定
          token: ${{ secrets.MY_PAT }} # 共通側への書き込み権限が必要なため MY_PAT を使用
          path: common-lib

      # --- 3. プロジェクトで直した zazlib を共通側へコピー ---
      - name: Sync Back to Common
        run: |
          # rsyncコマンドで同期。-c (checksum) で内容の差を厳格にチェック
          # 不要なGit設定ファイル(.git)やActions設定(.github)は除外してコピー
          rsync -avvc --delete \
            --exclude ".git/" \
            --exclude ".github/" \
            project-repo/zazlib/ common-lib/

      # --- 4. 共通リポジトリ(ZazLib)側に「修正提案(PR)」を作成 ---
      - name: Create Pull Request on Common Lib
        id: cpr_common
        uses: peter-evans/create-pull-request@v5
        with:
          path: common-lib
          token: ${{ secrets.MY_PAT }}
          # どのプロジェクトからの修正か分かるようにブランチ名を動的に作成
          branch: update-from-${{ github.event.repository.name }}
          title: "🚀 Update from ${{ github.event.repository.name }}"
          body: |
            ${{ github.event.repository.name }} で行われた修正を共通リポジトリへ書き戻します。
            このプルリクエストをマージすると、ZazLib側の notify.yml が走り、
            他の全プロジェクトへこの修正が自動配信されます。

      # --- 5. ZazLib側の「全プロジェクト通知(notify.yml)」を起動させる ---
      - name: Repository Dispatch to Common
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.MY_PAT }} # ZazLibのアクションを叩くために必要
          repository: zaz4416/ZazLib
          event-type: project_contribution # ZazLib側の notify.yml が待ち受けている名前
          # 無限ループを防ぐため「誰がこの変更の主導者か」をペイロードとして送信
          client-payload: '{"target_repo": "${{ github.repository }}"}'
