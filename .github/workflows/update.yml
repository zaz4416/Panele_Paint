name: Sync Common Folder

on:
  # 共通リポジトリ（ZazLib等）からの通知を受けて起動
  repository_dispatch:
    types: [common_lib_updated]
  # デバッグ用：GitHub上のActionsタブから手動実行も可能
  workflow_dispatch:

jobs:
  sync:
    # --- 1. ループ防止判定（自己PR防止） ---
    # 送信元の target_repo と 自分の名前（github.repository）が
    # 【一致しない】ときだけ実行する。ZazLibからの直接更新(null)も許可。
    if: |
      github.event.client_payload.target_repo == null || 
      github.event.client_payload.target_repo != github.repository

    runs-on: ubuntu-latest
    steps:
      # --- 2. デバッグ用：ログで判定の根拠を特定する ---
      - name: Debug Context Check
        run: |
          echo "--- Context Check ---"
          echo "Payload (from ZazLib): '${{ github.event.client_payload.target_repo }}'"
          echo "Current (This Repo):  '${{ github.repository }}'"
          echo "---------------------"

      # --- 3. リポジトリのチェックアウト ---
      - name: Checkout Project Repo
        uses: actions/checkout@v4
        with:
          path: project-repo
          token: ${{ secrets.MY_PAT }} # 自身の操作にも最強の合鍵を使用

      - name: Checkout Common Lib Repo
        uses: actions/checkout@v4
        with:
          # 汎用化：オーナー名と変数から共通リポジトリを特定
          repository: ${{ github.repository_owner }}/${{ vars.COMMON_REPO_NAME }}
          token: ${{ secrets.MY_PAT }}
          path: common-lib

      # --- 4. フォルダ同期（rsync） ---
      - name: Sync Folder from Common
        run: |
          # 変数を使用して同期先フォルダ(zazlib等)を特定・作成
          DEST_DIR="project-repo/${{ vars.SYNC_FOLDER_NAME }}"
          mkdir -p "$DEST_DIR"
          
          echo "--- Directory Structure Check ---"
          ls -R common-lib
          
          # 同期実行
          # -vv: 詳細ログ / -c: チェックサムで厳格に内容を比較
          # common-lib/ の末尾スラッシュは「中身」を指します
          rsync -avvc --delete \
            --exclude ".git/" \
            --exclude ".github/" \
            common-lib/ "$DEST_DIR/"

      # --- 5. 変更があればプルリクエスト作成 ---
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          path: project-repo
          token: ${{ secrets.MY_PAT }}
          commit-message: "🤖 ${{ github.repository }} (${{ vars.SYNC_FOLDER_NAME }}) を同期更新"
          branch: sync-common-library
          
          # タイトルに変更先のリポジトリ名を入れる
          title: "🤖 Zazlib同期 [target: ${{ github.repository }}]"
          
          # 本文に詳細を記載
          body: |
            ## 共通リポジトリの自動同期レポート
            
            **同期先リポジトリ:** 
            - [${{ github.repository }}](https://github.com/${{ github.repository }})
            
            **対象フォルダ:** 
            - `${{ vars.SYNC_FOLDER_NAME }}`
            
            **更新のトリガー:** 
            - 送信元: ${{ github.event.client_payload.target_repo || vars.COMMON_REPO_NAME }}
            
            共通リポジトリの内容を反映しました。内容を確認し、問題なければマージしてください。
          
          # マージ後に不要になった作業ブランチを自動で削除する
          delete-branch: true
